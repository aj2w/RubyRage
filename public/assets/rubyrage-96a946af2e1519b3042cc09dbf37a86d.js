function prepareEmptyPreset(){for(var e=0;150>e;e++)rubymonPairsPreset[e]=[0,0]}function prepareRubymonPreset(){prepareEmptyPreset();for(var e=[60,60,60,60,60],r=0;300>r;r++){var n=_.random(0,e.length-1);e[n]>0&&(rubymonPairsPreset[r%150][Math.floor(r/150)]=colors[n],e[n]--)}}function deployNewRubymonPair(){var e=rubymonPairsPreset[runningRubymonIndex];currentRubyBox=[[e[0],0],[e[1],0]],currentX=2,currentY=0,runningRubymonIndex=(runningRubymonIndex+1)%rubymonPairsPreset.length}function prepareBlankGameboardArray(){gameboardInplay=gameboardInit}function newGame(){clearInterval(interval),prepareBlankGameboardArray(),prepareRubymonPreset(),deployNewRubymonPair(),lostStatus=!1,interval=setInterval(tick,tickSpeed)}function tick(){if(checkIfValidMove(0,1))return currentY++,void 0;if(!freeze()&&!clear())return lostStatus?(newGame(),!1):(deployNewRubymonPair(),void 0)}function freeze(){for(var e=1;e>=0;--e)for(var r=0;2>r;++r)(e+currentY>=gameboardRows-1||0!=gameboardInplay[e+1+currentY][r+currentX])&&currentRubyBox[e][r]&&(gameboardInplay[e+currentY][r+currentX]=currentRubyBox[e][r],currentRubyBox[e][r]=0);for(var e=1;e>=0;--e)for(var r=0;2>r;++r)if(currentRubyBox[e][r])return!0;return!1}function rotate(e){newX=0,newY=0,0!==e[0][0]?0!==e[0][1]?(newX=-1,(11===currentY||0!==gameboardInplay[currentY+1][currentX])&&newY--):0!==e[1][0]&&(newY=1,5==currentX?newX--:0!=gameboardInplay[currentY+1][currentX+newX+1]&&newY--):0!=e[1][1]&&(0!=e[0][1]?(newY=-1,-1==currentX&&(newX++,newY++)):0!==e[1][0]&&(newX=1));for(var r=[],n=0;2>n;++n){r[n]=[];for(var a=0;2>a;++a)r[n][a]=e[1-a][n]}return r}function pauseScreen(){0!==interval?(clearInterval(interval),interval=0):interval=setInterval(tick,tickSpeed)}function clear(){var e;e=!1;for(var r=0;gameboardRows>r;++r)for(var n=0;gameboardColumns>n;++n)0!==gameboardInplay[r][n]&&clearPuyo(n,r)&&(e=!0);return e?(0!==interval&&(clearInterval(interval),interval=0,inputFlag=!1,rensaInterval=setInterval(clear,500)),bringRubymonsDown(),rensaCount++,!0):(0===interval&&(clearInterval(rensaInterval),deployNewRubymonPair(),interval=setInterval(tick,tickSpeed),inputFlag=!0,rensaCount=0),!1)}function bringRubymonsDown(){for(var e=0;gameboardColumns>e;++e)for(var r=0;gameboardRows-1>r;++r){var n=gameboardRows-r-2;if(0!=gameboardInplay[n][e]){for(var a=n+1;gameboardRows>a&&0==gameboardInplay[a][e];a++);a!=n+1&&0==gameboardInplay[a-1][e]&&(gameboardInplay[a-1][e]=gameboardInplay[n][e],gameboardInplay[n][e]=0)}}}function createRubymon(e,r,n){var a={x:e,y:r,col:n};return a}function clearPuyo(e,r){for(var n=[],a=0;gameboardRows>a;a++){n[a]=[];for(var o=0;gameboardColumns>o;o++)n[a][o]=0}var t=createRubymon(e,r,gameboardInplay[r][e]),u=[t];if(0===t.col||"gray"==t.col)return!1;if(findPuyos(u,n),u.length>=4){for(;t=u.pop();)gameboardInplay[t.y][t.x]=0;return!0}return!1}function checkPuyo(e,r,n,a,o,t){e&&(gameboardInplay[n][r]==a?(o.push(createRubymon(r,n,a)),findPuyos(o,t)):t[n][r]=!0)}function findPuyos(e,r){for(var n=e.pop(),a=0;a<e.length;a++)if(e[a].x==n.x&&e[a].y==n.y&&e[a].col==n.col)return;if(e.push(n),0==n.col)return r[n.y][n.x]=!0,void 0;if(1!=r[n.y][n.x]){r[n.y][n.x]=!0;var o=n.x,t=n.y,u=n.col;checkPuyo(o>0,o-1,t,u,e,r),checkPuyo(gameboardColumns-1>o,o+1,t,u,e,r),checkPuyo(t>1,o,t-1,u,e,r),checkPuyo(gameboardRows-1>t,o,t+1,u,e,r)}}function keyPress(e){if(inputFlag!==!1)switch(e){case"left":checkIfValidMove(-1,0)&&puyoSize()>1&&--currentX;break;case"right":checkIfValidMove(1,0)&&puyoSize()>1&&++currentX;break;case"down":checkIfValidMove(0,1)&&puyoSize()>1&&++currentY;break;case"rotate":var r=rotate(currentRubyBox);checkIfValidMove(newX,newY,r)?(currentRubyBox=r,currentX+=newX,currentY+=newY):checkIfValidMove(newX+anotherX,newY+anotherY,r)&&(currentRubyBox=r,currentX=currentX+newX+anotherX,currentY=currentY+newY+anotherY);break;case"pauseScreen":pauseScreen()}}function checkIfValidMove(e,r,n){e=currentX+e,r=currentY+r,n=n||currentRubyBox;for(var a=0;2>a;++a)for(var o=0;2>o;++o)if(n[a][o]&&("undefined"==typeof gameboardInplay[a+r]||"undefined"==typeof gameboardInplay[a+r][o+e]||gameboardInplay[a+r][o+e]||0>o+e||a+r>=gameboardRows||o+e>=gameboardColumns))return 3==r&&2==e&&(lostStatus=!0),2==r&&2==e&&(lostStatus=!0),!1;return!0}function puyoSize(){for(var e=0,r=1;r>=0;--r)for(var n=0;2>n;++n)0!==currentRubyBox[n][r]&&e++;return e}function selectRubymon(e){return rubymonImgArray[e]}function showRubymon(e,r,n,a){e.drawImage(r,0,0,60,58,eachColumnWidth*n,eachRowHeight*a,50,40)}function renderSittingRubymons(){for(var e=0;gameboardColumns>e;++e)for(var r=0;gameboardRows>r;++r){var n=selectRubymon(gameboardInplay[r][e]);showRubymon(ctxGameboard,n,e,r)}}function renderFallingRubymons(){for(var e=0;2>e;e++)for(var r=0;2>r;r++){var n=selectRubymon(currentRubyBox[e][r]);showRubymon(ctxGameboard,n,currentX+r,currentY+e)}}function renderNextRubymons(){for(var e=rubymonPairsPreset[runningRubymonIndex],r=0;2>r;r++){var n=selectRubymon(e[r]);showRubymon(ctxPreview,n,0,r)}}function paintOverGameboardAndPrewview(){ctxGameboard.fillStyle="lightgrey",ctxGameboard.fillRect(0,0,gameboardWitdh,gameboardHeight),ctxPreview.fillStyle="lightblue",ctxPreview.fillRect(0,0,previewWitdh,previewdHeight)}function renderAll(){paintOverGameboardAndPrewview(),renderSittingRubymons(),renderFallingRubymons(),renderNextRubymons()}$("#start-button").click(function(){newGame(),setInterval(renderAll,30)});var gameboard=$("#gameboard")[0],ctxGameboard=gameboard.getContext("2d"),gameboardColumns=6,gameboardRows=12,gameboardWitdh=300,gameboardHeight=480,eachColumnWidth=gameboardWitdh/gameboardColumns,eachRowHeight=gameboardHeight/gameboardRows,preview=$("#preview")[0],ctxPreview=preview.getContext("2d"),previewWitdh=50,previewdHeight=100,rubymonImgArray=$(".rubymon-img"),colors=[1,2,3,4,5,6],inputFlag=!0,rensaCount=0,anotherX=0,anotherY=0,currentRubyBox,currentX,currentY,newX,newY,lostStatus,interval,tickSpeed=450,rensaInterval,gameboardInplay,gameboardInit=[[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0]],rubymonPairsPreset=[],runningRubymonIndex=0;document.body.onkeydown=function(e){var r={37:"left",39:"right",40:"down",38:"rotate",13:"pauseScreen"};"undefined"!=typeof r[e.keyCode]&&keyPress(r[e.keyCode])};var rubyRageBattleMode={opponentGameboard:$("#opponent-gameboard")[0],opponentPreview:$("#opponent-preview")[0],returnCtxOpponentGameboard:function(){return this.opponentGameboard.getContext("2d")},returnCtxOpponentPreview:function(){return this.opponentPreview.getContext("2d")},reassembleTwoDimArray:function(e){var r=[],n=e.length;for(i=0;n>i;i++){var a=_.map(e[i],function(e){return parseInt(e,10)});r.push(a)}return r},renderOpponentsSittingRubymons:function(e,r){for(var n=0;gameboardColumns>n;n++)for(var a=0;gameboardRows>a;a++){var o=selectRubymon(e[a][n]);showRubymon(r,o,n,a)}},renderOpponentsFallingRubymons:function(e,r,n,a){for(var o=0;2>o;o++)for(var t=0;2>t;t++){var u=selectRubymon(e[o][t]);showRubymon(r,u,n+t,a+o)}},renderOpponentsNextRubymons:function(e,r){for(var n=0;2>n;n++){var a=selectRubymon(e[n]);showRubymon(r,a,0,n)}},paintOverOpponents:function(e,r){e.fillStyle="lightgrey",e.fillRect(0,0,gameboardWitdh,gameboardHeight),r.fillStyle="lightblue",r.fillRect(0,0,previewWitdh,previewdHeight)}};